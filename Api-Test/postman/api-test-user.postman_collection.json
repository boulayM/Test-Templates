{
  "info": {
    "_postman_id": "9c3b8f8a-user-0000-0000-000000000000",
    "name": "Api-Test User Collection",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "const csrfFromCookie = pm.cookies.get('csrfToken');",
          "if (csrfFromCookie) {",
          "  pm.collectionVariables.set('csrfToken', csrfFromCookie);",
          "}",
          "",
          "const method = (pm.request.method || '').toUpperCase();",
          "const url = pm.request.url.toString();",
          "const mutating = ['POST', 'PUT', 'PATCH', 'DELETE'].includes(method);",
          "const skip = [",
          "  '/api/auth/login',",
          "  '/api/auth/register',",
          "  '/api/auth/refresh',",
          "  '/api/csrf'",
          "].some((path) => url.includes(path));",
          "",
          "if (mutating && !skip) {",
          "  const token = pm.collectionVariables.get('csrfToken');",
          "  if (token) {",
          "    pm.request.headers.upsert({ key: 'x-csrf-token', value: token });",
          "  }",
          "}"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "const csrfFromCookie = pm.cookies.get('csrfToken');",
          "if (csrfFromCookie) {",
          "  pm.collectionVariables.set('csrfToken', csrfFromCookie);",
          "}",
          "",
          "const url = pm.request.url.toString();",
          "const isProviderStatus = url.includes('/api/public/payments/providers/status') || url.includes('/api/public/shipments/providers/status');",
          "",
          "if (isProviderStatus) {",
          "  pm.test('Provider status endpoint (known limitation: may return 501)', function () {",
          "    pm.expect([200, 501]).to.include(pm.response.code);",
          "  });",
          "} else {",
          "  pm.test('Response is not 5xx', function () {",
          "    pm.expect(pm.response.code).to.be.below(500);",
          "  });",
          "}"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "00 Setup User",
      "item": [
        {
          "name": "Get CSRF",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/csrf"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const responseData = pm.response.json();",
                  "if (responseData && responseData.csrfToken) {",
                  "  pm.collectionVariables.set('csrfToken', responseData.csrfToken);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Login User",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/auth/login",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"{{userEmail}}\",\n  \"password\": \"{{userPassword}}\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const responseData = pm.response.json();",
                  "if (responseData && responseData.user && responseData.user.id) {",
                  "  pm.collectionVariables.set('userId', responseData.user.id);",
                  "}",
                  "const csrf = pm.cookies.get('csrfToken');",
                  "if (csrf) {",
                  "  pm.collectionVariables.set('csrfToken', csrf);",
                  "}"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "10 Auth User",
      "item": [
        {
          "name": "Auth Me",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/auth/me"
          }
        },
        {
          "name": "Auth Refresh",
          "request": {
            "method": "POST",
            "url": "{{baseUrl}}/api/auth/refresh"
          }
        }
      ]
    },
    {
      "name": "20 Public",
      "item": [
        {
          "name": "Abandon Cart",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "url": "{{baseUrl}}/api/public/cart/abandon",
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          }
        },
        {
          "name": "Add Item",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/public/cart/items",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"productId\": \"{{productId}}\",\n  \"quantity\": 1\n}"
            }
          }
        },
        {
          "name": "Create Address",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/public/addresses",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"label\": \"Home\",\n  \"fullName\": \"John Doe\",\n  \"phone\": \"0102030405\",\n  \"line1\": \"1 Main St\",\n  \"line2\": null,\n  \"postalCode\": \"75001\",\n  \"city\": \"Paris\",\n  \"country\": \"FR\",\n  \"isDefault\": true\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const responseData = pm.response.json();",
                  "if (responseData && responseData.id) {",
                  "  pm.collectionVariables.set('addressId', responseData.id);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Order",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/public/orders",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"items\": [\n    {\"productId\": \"{{productId}}\", \"quantity\": 1}\n  ],\n  \"shippingAddressId\": \"{{addressId}}\",\n  \"billingAddressId\": \"{{addressId}}\",\n  \"currency\": \"EUR\",\n  \"shippingCents\": 500,\n  \"discountCents\": 0\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const responseData = pm.response.json();",
                  "if (responseData && responseData.id) {",
                  "  pm.collectionVariables.set('orderId', responseData.id);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Payment",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/public/payments",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"orderId\": \"{{orderId}}\",\n  \"provider\": \"STRIPE\",\n  \"amountCents\": 1000,\n  \"currency\": \"EUR\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const responseData = pm.response.json();",
                  "if (responseData && responseData.id) {",
                  "  pm.collectionVariables.set('paymentId', responseData.id);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "Create Review",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/public/reviews",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"productId\": \"{{productId}}\",\n  \"rating\": 5,\n  \"comment\": \"Great\"\n}"
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const responseData = pm.response.json();",
                  "if (responseData && responseData.id) {",
                  "  pm.collectionVariables.set('reviewId', responseData.id);",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "DELETE /api/public/addresses/{{id}}",
          "request": {
            "method": "DELETE",
            "url": "{{baseUrl}}/api/public/addresses/{{id}}",
            "header": [
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ]
          }
        },
        {
          "name": "DELETE /api/public/cart/items/{{id}}",
          "request": {
            "method": "DELETE",
            "url": "{{baseUrl}}/api/public/cart/items/{{id}}",
            "header": [
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ]
          }
        },
        {
          "name": "DELETE /api/public/reviews/{{id}}",
          "request": {
            "method": "DELETE",
            "url": "{{baseUrl}}/api/public/reviews/{{id}}",
            "header": [
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ]
          }
        },
        {
          "name": "Delete Address",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/public/addresses/{{addressId}}"
          }
        },
        {
          "name": "Delete Review",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/public/reviews/{{reviewId}}"
          }
        },
        {
          "name": "GET /api/public/categories",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/categories"
          }
        },
        {
          "name": "GET /api/public/categories/{{id}}",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/categories/{{id}}"
          }
        },
        {
          "name": "GET /api/public/coupons/validate",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/coupons/validate"
          }
        },
        {
          "name": "GET /api/public/inventory",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/inventory"
          }
        },
        {
          "name": "GET /api/public/orders/{{id}}",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/orders/{{id}}"
          }
        },
        {
          "name": "GET /api/public/products",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/products"
          }
        },
        {
          "name": "GET /api/public/products/{{id}}",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/products/{{id}}"
          }
        },
        {
          "name": "GET /api/public/shipments",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/shipments"
          }
        },
        {
          "name": "Get Addresses",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/addresses"
          }
        },
        {
          "name": "Get My Cart",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/cart"
          }
        },
        {
          "name": "Get Order",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/orders/{{orderId}}"
          }
        },
        {
          "name": "Get Order Shipments",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/orders/{{orderId}}/shipments"
          }
        },
        {
          "name": "Get Orders",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/orders"
          }
        },
        {
          "name": "Get Payment By Order",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/payments/{{orderId}}"
          }
        },
        {
          "name": "Get Payments",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/payments"
          }
        },
        {
          "name": "Get Payments Provider Status",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/payments/providers/status"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Known limitation documented: provider endpoint may be 501 in test API', function () {",
                  "  pm.expect([200, 501]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Product",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/products/{{productId}}"
          }
        },
        {
          "name": "Get Reviews",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/reviews"
          }
        },
        {
          "name": "Get Shipments Provider Status",
          "request": {
            "method": "GET",
            "url": "{{baseUrl}}/api/public/shipments/providers/status"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Known limitation documented: provider endpoint may be 501 in test API', function () {",
                  "  pm.expect([200, 501]).to.include(pm.response.code);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "PATCH /api/public/addresses/{{id}}",
          "request": {
            "method": "PATCH",
            "url": "{{baseUrl}}/api/public/addresses/{{id}}",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          }
        },
        {
          "name": "PATCH /api/public/cart/items/{{id}}",
          "request": {
            "method": "PATCH",
            "url": "{{baseUrl}}/api/public/cart/items/{{id}}",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          }
        },
        {
          "name": "PATCH /api/public/reviews/{{id}}",
          "request": {
            "method": "PATCH",
            "url": "{{baseUrl}}/api/public/reviews/{{id}}",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{}"
            }
          }
        },
        {
          "name": "Remove Item",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/public/cart/items/{{productId}}"
          }
        },
        {
          "name": "Update Address",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/public/addresses/{{addressId}}",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"city\": \"Lyon\"\n}"
            }
          }
        },
        {
          "name": "Update Item",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/public/cart/items/{{productId}}",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"quantity\": 2\n}"
            }
          }
        },
        {
          "name": "Update Review",
          "request": {
            "method": "PATCH",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/public/reviews/{{reviewId}}",
            "body": {
              "mode": "raw",
              "raw": "{\n  \"rating\": 4\n}"
            }
          }
        }
      ]
    },
    {
      "name": "99 Teardown User",
      "item": [
        {
          "name": "Auth Logout",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "x-csrf-token",
                "value": "{{csrfToken}}"
              }
            ],
            "url": "{{baseUrl}}/api/auth/logout"
          }
        }
      ]
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000"
    },
    {
      "key": "adminEmail",
      "value": "admin@example.com"
    },
    {
      "key": "adminPassword",
      "value": "Admin123!"
    },
    {
      "key": "userEmail",
      "value": "alice@example.com"
    },
    {
      "key": "userPassword",
      "value": "User123!"
    },
    {
      "key": "newUserEmail",
      "value": "new.user@example.com"
    },
    {
      "key": "createdUserEmail",
      "value": "created.user@example.com"
    },
    {
      "key": "captchaToken",
      "value": ""
    },
    {
      "key": "verifyToken",
      "value": ""
    },
    {
      "key": "csrfToken",
      "value": ""
    },
    {
      "key": "adminId",
      "value": ""
    },
    {
      "key": "userId",
      "value": ""
    },
    {
      "key": "createdUserId",
      "value": ""
    },
    {
      "key": "categoryId",
      "value": ""
    },
    {
      "key": "productId",
      "value": ""
    },
    {
      "key": "addressId",
      "value": ""
    },
    {
      "key": "orderId",
      "value": ""
    },
    {
      "key": "couponId",
      "value": ""
    },
    {
      "key": "reviewId",
      "value": ""
    },
    {
      "key": "paymentId",
      "value": ""
    },
    {
      "key": "shipmentId",
      "value": ""
    },
    {
      "key": "auditLogId",
      "value": ""
    }
  ]
}
