generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
  LOGISTIQUE
  COMPTABILITE
}

enum CartStatus {
  ACTIVE
  CONVERTED
  ABANDONED
}

enum OrderStatus {
  PENDING
  PAID
  PREPARING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  PAYPAL
  MANUAL
}

enum PaymentStatus {
  CREATED
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
}

enum ShipmentStatus {
  CREATED
  IN_TRANSIT
  DELIVERED
  LOST
}

enum CouponType {
  PERCENT
  FIXED
}

model User {
  id                Int                 @id @default(autoincrement())
  firstName         String
  lastName          String
  email             String              @unique
  passwordHash      String
  role              UserRole            @default(USER)
  emailVerified     Boolean             @default(false)
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  addresses         Address[]
  carts             Cart[]
  orders            Order[]
  reviews           Review[]
  refreshTokens     RefreshToken[]
  verificationTokens VerificationToken[]
}

model Address {
  id           Int      @id @default(autoincrement())
  userId       Int
  label        String
  fullName     String
  phone        String
  line1        String
  line2        String?
  postalCode   String
  city         String
  country      String
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shippingFor  Order[]  @relation("OrderShippingAddress")
  billingFor   Order[]  @relation("OrderBillingAddress")

  @@index([userId])
}

model Category {
  id         Int        @id @default(autoincrement())
  name       String     @unique
  slug       String     @unique
  parentId   Int?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  parent     Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children   Category[] @relation("CategoryHierarchy")
  products   ProductCategory[]
}

model Product {
  id              Int               @id @default(autoincrement())
  name            String
  slug            String            @unique
  description     String
  priceCents      Int
  currency        String            @default("EUR")
  sku             String            @unique
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  images          ProductImage[]
  categories      ProductCategory[]
  inventory       Inventory?
  cartItems       CartItem[]
  orderItems      OrderItem[]
  reviews         Review[]
}

model ProductImage {
  id          Int      @id @default(autoincrement())
  productId   Int
  url         String
  alt         String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model ProductCategory {
  productId   Int
  categoryId  Int

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@index([categoryId])
}

model Inventory {
  id            Int      @id @default(autoincrement())
  productId     Int      @unique
  quantity      Int      @default(0)
  reserved      Int      @default(0)
  updatedAt     DateTime @updatedAt

  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Cart {
  id            Int        @id @default(autoincrement())
  userId        Int
  status        CartStatus @default(ACTIVE)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  user          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         CartItem[]
  orders        Order[]

  @@index([userId])
  @@index([status])
}

model CartItem {
  id               Int      @id @default(autoincrement())
  cartId           Int
  productId        Int
  quantity         Int
  unitPriceCents   Int
  currency         String   @default("EUR")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  cart             Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product          Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([cartId, productId])
  @@index([productId])
}

model Order {
  id                 Int         @id @default(autoincrement())
  userId             Int
  cartId             Int?
  shippingAddressId  Int
  billingAddressId   Int
  status             OrderStatus @default(PENDING)

  subtotalCents      Int
  shippingCents      Int         @default(0)
  discountCents      Int         @default(0)
  totalCents         Int
  currency           String      @default("EUR")

  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  user               User        @relation(fields: [userId], references: [id], onDelete: Restrict)
  cart               Cart?       @relation(fields: [cartId], references: [id], onDelete: SetNull)
  shippingAddress    Address     @relation("OrderShippingAddress", fields: [shippingAddressId], references: [id], onDelete: Restrict)
  billingAddress     Address     @relation("OrderBillingAddress", fields: [billingAddressId], references: [id], onDelete: Restrict)

  items              OrderItem[]
  payments           Payment[]
  shipments          Shipment[]
  coupons            OrderCoupon[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id               Int      @id @default(autoincrement())
  orderId          Int
  productId        Int?
  productName      String
  productSku       String
  quantity         Int
  unitPriceCents   Int
  currency         String   @default("EUR")
  createdAt        DateTime @default(now())

  order            Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product          Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
}

model Payment {
  id            Int             @id @default(autoincrement())
  orderId       Int
  provider      PaymentProvider
  providerRef   String?
  amountCents   Int
  currency      String
  status        PaymentStatus   @default(CREATED)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  order         Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

model Shipment {
  id              Int            @id @default(autoincrement())
  orderId         Int
  carrier         String?
  trackingNumber  String?
  status          ShipmentStatus @default(CREATED)
  shippedAt       DateTime?
  deliveredAt     DateTime?

  order           Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
}

model Coupon {
  id             Int         @id @default(autoincrement())
  code           String      @unique
  type           CouponType
  value          Int
  minOrderCents  Int?
  startsAt       DateTime?
  endsAt         DateTime?
  usageLimit     Int?
  usedCount      Int         @default(0)
  isActive       Boolean     @default(true)

  orders         OrderCoupon[]
}

model OrderCoupon {
  orderId        Int
  couponId       Int

  order          Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  coupon         Coupon  @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@id([orderId, couponId])
  @@index([couponId])
}

model Review {
  id           Int      @id @default(autoincrement())
  userId       Int
  productId    Int
  rating       Int
  comment      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
}

model RefreshToken {
  id         Int       @id @default(autoincrement())
  tokenHash  String    @unique
  userId     Int
  expiresAt  DateTime
  revokedAt  DateTime?
  createdAt  DateTime  @default(now())

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model VerificationToken {
  id         Int       @id @default(autoincrement())
  tokenHash  String    @unique
  userId     Int
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}
