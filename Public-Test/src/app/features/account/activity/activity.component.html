<!-- Message info pour USER -->
@if (auth.isLoggedIn() && !auth.isAdmin()) {
  <div class="alert alert-info text-center my-3">
    Pour ajouter des produits, ouvrez la page <strong>Catalogue</strong> puis cliquez sur "Ajouter au panier".
  </div>
}
<section class="container py-4">
  @for (activityRecord of activityRecords; track activityRecord) {
    <div class="card mb-3">
      <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
        <div>
          <strong>Panier #{{ activityRecord.id }}</strong>
          <span class="text-muted small">({{ activityRecord.status }})</span>
        </div>
        <div class="d-flex gap-2">
          <!-- Bouton ajouter element -->
          <a
            class="btn btn-primary btn-sm"
            [routerLink]="['/catalog']"
            [queryParams]="{ includeActivityId: activityRecord.id }"
          >
            Ajouter produit
          </a>
          <!-- Bouton supprimer l activite -->
          <button
            class="btn btn-secondary btn-sm"
            (click)="deleteActivityRecord(activityRecord.id)"
          >
            Vider le panier
          </button>
        </div>
      </div>
      <table class="table table-sm mt-3 mb-0">
        <thead>
          <tr>
            <th>Produit</th>
            <th>Quantite</th>
            <th>Prix unitaire</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          @for (item of activityRecord.items; track item) {
            <tr>
              <td>{{ item.contentItem.name }}</td>
              <td>
                <input
                  type="number"
                  min="1"
                  [(ngModel)]="item.quantity"
                  (change)="updateQuantity(activityRecord, item)"
                  class="form-control form-control-sm"
                />
              </td>
              <td>{{ item.price | currency: "EUR" }}</td>
              <td>
                <button
                  class="btn btn-danger btn-sm"
                  (click)="removeItem(activityRecord.id, item.contentItemId)"
                >
                  Retirer
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
      <div class="mt-2">
        <strong>Total estime: {{ getTotal(activityRecord) | currency: "EUR" }}</strong>
      </div>
      <div class="d-flex gap-2 align-items-center mt-2 flex-wrap">
        <input class="form-control w-auto" type="text" [(ngModel)]="couponCode" placeholder="Code promo" />
        <button class="btn btn-secondary btn-sm" (click)="applyCoupon(activityRecord)">
          Appliquer
        </button>
        @if (couponValid) {
          <span class="text-success">Coupon applique au checkout</span>
        }
      </div>
      <div class="mt-2 d-flex justify-content-end">
        <button class="btn btn-primary" (click)="goCheckout()">Commander</button>
      </div>
    </div>
  }
</section>
